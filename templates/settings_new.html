{% extends "base.html" %}

{% block title %}Settings - Backup System{% endblock %}

{% block content %}
<div class="breadcrumb-professional">
    <a href="/">Dashboard</a>
    <span class="breadcrumb-separator">/</span>
    <span>Settings</span>
</div>

<h2 style="margin-bottom: var(--space-6);"><i class="bi bi-gear"></i> Settings</h2>

<!-- Google Account Connection -->
<div class="card-professional">
    <div class="card-professional-header">
        <h5><i class="bi bi-google"></i> Google Account Connection</h5>
    </div>
    <div class="card-professional-body">
        {% if google_connected %}
            <div class="alert-professional alert-professional-success">
                <i class="bi bi-check-circle-fill"></i>
                <div>
                    <strong>Connected</strong>
                    {% if google_user %}
                        <div style="margin-top: var(--space-3); display: flex; align-items: center; gap: var(--space-3);">
                            {% if google_user.picture %}
                                <img src="{{ google_user.picture }}" alt="Profile" class="rounded-circle" width="40" height="40">
                            {% endif %}
                            <div>
                                <strong>{{ google_user.name }}</strong> ({{ google_user.email }})
                                {% if google_user.verified_email %}
                                    <i class="bi bi-patch-check-fill text-primary" title="Verified"></i>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="btn-group-professional">
                <a href="{{ url_for('google_disconnect') }}" class="btn-professional-danger" 
                   onclick="return confirm('Are you sure you want to disconnect your Google account?')">
                    <i class="bi bi-plug"></i> Disconnect
                </a>
                <button class="btn-professional-secondary" onclick="testGoogleConnection()">
                    <i class="bi bi-speedometer2"></i> Test Connection
                </button>
            </div>
            
            <div id="test-result" class="mt-4"></div>
        {% else %}
            <div class="alert-professional alert-professional-warning">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <div>
                    <strong>Not Connected</strong>
                    <p style="margin: var(--space-2) 0 0 0;">Connect your Google account to enable syncing of Google Drive and Google Photos.</p>
                </div>
            </div>
            
            <a href="{{ url_for('google_authorize') }}" class="btn-professional-primary">
                <i class="bi bi-google"></i> Connect Google Account
            </a>
            
            <div style="margin-top: var(--space-4); padding: var(--space-4); background: var(--gray-50); border-radius: var(--radius-md);">
                <strong style="font-size: var(--text-sm);">Required Permissions:</strong>
                <ul style="margin: var(--space-2) 0 0 0; font-size: var(--text-sm); color: var(--gray-700);">
                    <li>View your Google Drive files (read-only)</li>
                    <li>View your Google Photos library (read-only)</li>
                    <li>View your basic profile info</li>
                </ul>
            </div>
        {% endif %}
    </div>
</div>

<!-- Sync Configuration -->
<div class="card-professional">
    <div class="card-professional-header">
        <h5><i class="bi bi-arrow-repeat"></i> Sync Configuration</h5>
    </div>
    <div class="card-professional-body">
        <div class="row">
            <div class="col-md-6">
                <h6 style="margin-bottom: var(--space-3);">Google Drive</h6>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="driveSyncEnabled" 
                           {% if config.sources.google_drive.enabled %}checked{% endif %} disabled>
                    <label class="form-check-label" for="driveSyncEnabled">
                        Sync Enabled
                    </label>
                </div>
                <small class="text-muted">Local path: {{ config.sources.google_drive.local_path }}</small>
            </div>
        </div>
        <div style="margin-top: var(--space-4); padding: var(--space-3); background: var(--gray-50); border-radius: var(--radius-sm);">
            <i class="bi bi-info-circle"></i>
            <small class="text-muted">
                Edit <code>config.yaml</code> to change sync settings. 
                Configure which folders to backup in the <a href="/files">Files</a> section.
            </small>
        </div>
    </div>
</div>

<!-- Destination Configuration -->
<div class="card-professional">
    <div class="card-professional-header">
        <h5><i class="bi bi-cloud-upload"></i> Backup Destinations</h5>
    </div>
    <div class="card-professional-body">
        <div class="row">
            <div class="col-md-4">
                <div style="padding: var(--space-4); background: var(--gray-50); border-radius: var(--radius-md); height: 100%;">
                    <h6 style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-3);">
                        <i class="bi bi-amazon" style="color: #FF9900; font-size: 1.5rem;"></i> AWS S3
                    </h6>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="awsEnabled" 
                               {% if config.destinations.aws_s3.enabled %}checked{% endif %} disabled>
                        <label class="form-check-label" for="awsEnabled">
                            <strong>Enabled</strong>
                        </label>
                    </div>
                    <div style="font-size: var(--text-sm); color: var(--gray-700);">
                        <div style="margin-bottom: var(--space-2);">
                            <strong>Bucket:</strong> {{ config.destinations.aws_s3.bucket }}
                        </div>
                        <div style="margin-bottom: var(--space-2);">
                            <strong>Region:</strong> {{ config.destinations.aws_s3.region }}
                        </div>
                        <div>
                            <strong>Storage Class:</strong> {{ config.destinations.aws_s3.storage_class }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div style="padding: var(--space-4); background: var(--gray-50); border-radius: var(--radius-md); height: 100%;">
                    <h6 style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-3);">
                        <i class="bi bi-cloud-fill" style="color: #0091DA; font-size: 1.5rem;"></i> Backblaze B2
                    </h6>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="b2Enabled" 
                               {% if config.destinations.backblaze_b2.enabled %}checked{% endif %} disabled>
                        <label class="form-check-label" for="b2Enabled">
                            <strong>Enabled</strong>
                        </label>
                    </div>
                    <div style="font-size: var(--text-sm); color: var(--gray-700);">
                        <div>
                            <strong>Bucket:</strong> {{ config.destinations.backblaze_b2.bucket }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div style="padding: var(--space-4); background: var(--gray-50); border-radius: var(--radius-md); height: 100%;">
                    <h6 style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-3);">
                        <i class="bi bi-hdd-network" style="color: var(--gray-600); font-size: 1.5rem;"></i> EU Provider
                    </h6>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="euEnabled" 
                               {% if config.destinations.eu_provider.enabled %}checked{% endif %} disabled>
                        <label class="form-check-label" for="euEnabled">
                            <strong>Enabled</strong>
                        </label>
                    </div>
                    <div style="font-size: var(--text-sm); color: var(--gray-700);">
                        <div style="margin-bottom: var(--space-2);">
                            <strong>Bucket:</strong> {{ config.destinations.eu_provider.bucket }}
                        </div>
                        <div>
                            <strong>Region:</strong> {{ config.destinations.eu_provider.region }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Settings -->
<div class="card-professional">
    <div class="card-professional-header">
        <h5><i class="bi bi-sliders"></i> Advanced Settings</h5>
    </div>
    <div class="card-professional-body">
        <table class="table-professional">
            <tbody>
                <tr>
                    <td style="width: 30%;"><strong>Sync Mode</strong></td>
                    <td>{{ config.sync.mode }}</td>
                </tr>
                <tr>
                    <td><strong>Batch Size</strong></td>
                    <td>{{ config.sync.batch_size }} files</td>
                </tr>
                <tr>
                    <td><strong>Retry Attempts</strong></td>
                    <td>{{ config.sync.retry_attempts }}</td>
                </tr>
                <tr>
                    <td><strong>Max File Size</strong></td>
                    <td>{{ config.sync.max_file_size_gb }} GB</td>
                </tr>
            </tbody>
        </table>
        <div style="margin-top: var(--space-4); padding: var(--space-3); background: var(--gray-50); border-radius: var(--radius-sm);">
            <i class="bi bi-info-circle"></i>
            <small class="text-muted">
                To configure which folders to backup, go to the <a href="/files" class="text-decoration-none">Files</a> section.
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function testGoogleConnection() {
        const resultDiv = document.getElementById('test-result');
        resultDiv.innerHTML = '<div class="spinner-professional"></div><p style="margin-top: var(--space-3);">Testing connection...</p>';
        
        fetch('/google/test')
            .then(response => response.json())
            .then(data => {
                let html = '<div class="card-professional"><div class="card-professional-body">';
                html += '<h6 style="margin-bottom: var(--space-4);">Connection Test Results</h6>';
                
                if (data.drive) {
                    if (data.drive.success) {
                        html += '<div class="alert-professional alert-professional-success">';
                        html += '<i class="bi bi-check-circle"></i>';
                        html += '<div><strong>Google Drive:</strong> Connected<br>';
                        html += '<small>User: ' + data.drive.user + '<br>';
                        html += 'Storage: ' + formatBytes(data.drive.storage_used) + ' / ' + formatBytes(data.drive.storage_limit) + '</small></div>';
                        html += '</div>';
                    } else {
                        html += '<div class="alert-professional alert-professional-error">';
                        html += '<i class="bi bi-x-circle"></i>';
                        html += '<div><strong>Google Drive:</strong> Error<br>';
                        html += '<small>' + data.drive.error + '</small></div>';
                        html += '</div>';
                    }
                }
                
                if (data.photos) {
                    if (data.photos.success) {
                        html += '<div class="alert-professional alert-professional-success">';
                        html += '<i class="bi bi-check-circle"></i>';
                        html += '<div><strong>Google Photos:</strong> Connected</div>';
                        html += '</div>';
                    } else {
                        html += '<div class="alert-professional alert-professional-error">';
                        html += '<i class="bi bi-x-circle"></i>';
                        html += '<div><strong>Google Photos:</strong> Error<br>';
                        html += '<small>' + data.photos.error + '</small></div>';
                        html += '</div>';
                    }
                }
                
                html += '</div></div>';
                resultDiv.innerHTML = html;
            })
            .catch(error => {
                resultDiv.innerHTML = '<div class="alert-professional alert-professional-error"><i class="bi bi-x-circle"></i><div>Error testing connection: ' + error + '</div></div>';
            });
    }
    
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
</script>
{% endblock %}
