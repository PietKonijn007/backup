{% extends "base.html" %}

{% block title %}Files - Backup System{% endblock %}

{% block extra_css %}
<style>
    .files-card {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }
    
    body[data-theme="classic"] .files-card {
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    
    .files-header {
        background: linear-gradient(135deg, #232F3E 0%, #37475A 100%);
        color: white;
        padding: 30px;
    }
    
    body[data-theme="classic"] .files-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .tree-container {
        padding: 20px;
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .tree-header {
        display: flex;
        align-items: center;
        padding: 12px;
        background: var(--gray-50);
        border-bottom: 2px solid var(--gray-300);
        font-weight: 600;
        font-size: 13px;
        color: var(--gray-700);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .tree-node {
        padding: 8px 12px;
        margin: 2px 0;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        user-select: none;
    }
    
    .tree-node:hover {
        background: var(--gray-50);
    }
    
    .tree-node-main {
        display: flex;
        align-items: center;
        flex: 1;
        gap: 10px;
        min-width: 0;
    }
    
    .tree-node-destinations {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-left: auto;
        padding-left: 20px;
    }
    
    .dest-checkbox-group {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 4px;
        background: var(--gray-50);
        transition: all 0.2s;
    }
    
    .dest-checkbox-group:hover {
        background: var(--gray-200);
    }
    
    .dest-checkbox-group.active {
        background: #e3f2fd;
    }
    
    .dest-checkbox-group input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
    }
    
    .dest-checkbox-group label {
        margin: 0;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .dest-icon-aws { color: #FF9900; }
    .dest-icon-b2 { color: #0091DA; }
    
    .tree-indent {
        display: inline-block;
        width: 24px;
    }
    
    .tree-expand {
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 3px;
        transition: all 0.2s ease;
    }
    
    .tree-expand:hover {
        background: var(--gray-200);
    }
    
    .tree-expand.collapsed i {
        transform: rotate(-90deg);
    }
    
    .tree-children {
        margin-left: 24px;
    }
    
    .tree-children.collapsed {
        display: none;
    }
    
    .file-icon {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }
    
    .file-icon.folder { background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%); color: white; }
    .file-icon.document { background: linear-gradient(135deg, #42A5F5 0%, #1E88E5 100%); color: white; }
    .file-icon.spreadsheet { background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%); color: white; }
    .file-icon.presentation { background: linear-gradient(135deg, #FFA726 0%, #F57C00 100%); color: white; }
    .file-icon.image { background: linear-gradient(135deg, #EC407A 0%, #D81B60 100%); color: white; }
    .file-icon.video { background: linear-gradient(135deg, #AB47BC 0%, #8E24AA 100%); color: white; }
    .file-icon.pdf { background: linear-gradient(135deg, #EF5350 0%, #E53935 100%); color: white; }
    .file-icon.default { background: linear-gradient(135deg, #78909C 0%, #546E7A 100%); color: white; }
    
    .file-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--gray-900);
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .file-meta {
        font-size: 12px;
        color: var(--gray-600);
        margin-left: 10px;
    }
    
    .badge-synced {
        background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%);
        color: white;
        font-size: 10px;
        padding: 3px 8px;
        border-radius: 10px;
        margin-left: 8px;
    }
    
    .backup-status-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        font-size: 11px;
        margin-left: 4px;
        cursor: help;
    }
    
    .backup-status-icon.synced { color: var(--success); }
    .backup-status-icon.pending { color: var(--warning); }
    .backup-status-icon.failed { color: var(--error); }
    .backup-status-icon.not-configured { color: var(--gray-500); }
    
    .backup-status-group {
        display: flex;
        align-items: center;
        gap: 2px;
        padding: 2px 6px;
        border-radius: 3px;
        background: var(--gray-50);
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .storage-info {
        background: white;
        border-radius: var(--radius-md);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        margin-bottom: 20px;
        border: 1px solid var(--gray-300);
    }
    
    body[data-theme="classic"] .storage-info {
        border-radius: 15px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    
    .progress { 
        height: 10px; 
        border-radius: 10px;
        background-color: var(--gray-200);
    }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb-professional">
    <a href="/">Dashboard</a>
    <span class="breadcrumb-separator">/</span>
    <span>Files</span>
</div>

<!-- Storage Info -->
<div class="storage-info" id="storageInfo" style="display: none;">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h6 class="mb-2">Google Drive Storage</h6>
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%" id="storageProgress"></div>
            </div>
            <small class="text-muted mt-1 d-block" id="storageText">Loading...</small>
        </div>
        <div class="col-md-4 text-end">
            <h3 class="mb-0" id="storagePercentage">0%</h3>
            <small class="text-muted">Used</small>
        </div>
    </div>
</div>

<!-- Files Card -->
<div class="files-card">
    <div class="files-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2><i class="bi bi-folder2-open"></i> Backup Configuration</h2>
                <p class="mb-0">Configure which Google Drive folders to backup and select their destinations (AWS S3, Backblaze B2)</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-light btn-sm" onclick="expandAll()">
                    <i class="bi bi-arrows-expand"></i> Expand All
                </button>
                <button class="btn btn-light btn-sm" onclick="collapseAll()">
                    <i class="bi bi-arrows-collapse"></i> Collapse All
                </button>
            </div>
        </div>
    </div>

    <!-- Tree Container -->
    <div class="tree-container" id="treeContainer">
        <div class="text-center py-5">
            <div class="spinner-professional"></div>
            <p class="mt-3 text-muted">Loading your Google Drive structure...</p>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-content text-center">
        <div class="spinner-professional"></div>
        <h4 class="mt-4">Building Complete Drive Structure...</h4>
        <p class="text-muted">This may take a few moments</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let driveTree = [];
    let folderPolicies = {};
    let syncStatusMap = {};
    let backupStatusMap = {};
    let folderStatsMap = {};

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function() {
        await Promise.all([
            loadFolderPolicies(),
            loadSyncStatus(),
            loadBackupStatus(),
            loadFolderStats(),
            loadStorageInfo()
        ]);
        await loadDriveTree();
    });

    async function loadFolderPolicies() {
        try {
            const response = await fetch('/api/folders/policies');
            const data = await response.json();
            if (data.success) {
                folderPolicies = {};
                data.policies.forEach(policy => {
                    folderPolicies[policy.folder_id] = {
                        destinations: policy.destinations || []
                    };
                });
            }
        } catch (error) {
            console.error('Error loading folder policies:', error);
        }
    }

    async function loadSyncStatus() {
        try {
            const response = await fetch('/api/sync/status');
            const data = await response.json();
            if (data.success) {
                syncStatusMap = data.status_map;
            }
        } catch (error) {
            console.error('Error loading sync status:', error);
        }
    }

    async function loadBackupStatus() {
        try {
            const response = await fetch('/api/files/backup-status');
            const data = await response.json();
            if (data.success) {
                backupStatusMap = data.backup_status;
            }
        } catch (error) {
            console.error('Error loading backup status:', error);
        }
    }

    async function loadFolderStats() {
        try {
            const response = await fetch('/api/folders/backup-stats');
            const data = await response.json();
            if (data.success) {
                folderStatsMap = data.folder_stats;
            }
        } catch (error) {
            console.error('Error loading folder stats:', error);
        }
    }

    async function loadStorageInfo() {
        try {
            const response = await fetch('/api/drive/storage');
            const data = await response.json();
            if (data.success) {
                const storage = data.storage;
                document.getElementById('storageInfo').style.display = 'block';
                document.getElementById('storageProgress').style.width = storage.percentage + '%';
                document.getElementById('storagePercentage').textContent = storage.percentage + '%';
                document.getElementById('storageText').textContent = 
                    `${storage.usage_formatted} of ${storage.limit_formatted} used`;
                
                const progressBar = document.getElementById('storageProgress');
                progressBar.className = storage.percentage > 90 ? 'progress-bar bg-danger' :
                                      storage.percentage > 75 ? 'progress-bar bg-warning' : 'progress-bar bg-success';
            }
        } catch (error) {
            console.error('Error loading storage info:', error);
        }
    }

    async function loadDriveTree() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        try {
            const response = await fetch('/api/drive/tree');
            const data = await response.json();
            if (data.success) {
                driveTree = data.tree;
                renderTree();
            } else {
                document.getElementById('treeContainer').innerHTML = `
                    <div class="alert-professional alert-professional-error">
                        <i class="bi bi-x-circle"></i>
                        <div>
                            <h5>Error loading Drive structure</h5>
                            <p>${data.error}</p>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            document.getElementById('treeContainer').innerHTML = `
                <div class="alert-professional alert-professional-error">
                    <i class="bi bi-x-circle"></i>
                    <div>
                        <h5>Error loading Drive structure</h5>
                        <p>${error.message}</p>
                    </div>
                </div>
            `;
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }

    function renderTree() {
        const container = document.getElementById('treeContainer');
        let html = `
            <div class="tree-header">
                <div style="flex: 1;">File / Folder</div>
                <div style="display: flex; gap: 20px;">
                    <div style="width: 100px; text-align: center;">
                        <i class="bi bi-amazon dest-icon-aws"></i> AWS S3
                    </div>
                    <div style="width: 100px; text-align: center;">
                        <i class="bi bi-cloud-fill dest-icon-b2"></i> B2
                    </div>
                </div>
            </div>
        `;
        html += renderNodes(driveTree, 0);
        container.innerHTML = html;
        
        // Set indeterminate state on checkboxes
        document.querySelectorAll('input[data-indeterminate="true"]').forEach(checkbox => {
            checkbox.indeterminate = true;
        });
    }

    function hasDestination(folderId, destination, parentPath = []) {
        const policy = folderPolicies[folderId];
        if (policy) {
            return policy.destinations.includes(destination);
        }
        for (const parentId of parentPath) {
            const parentPolicy = folderPolicies[parentId];
            if (parentPolicy && parentPolicy.destinations.includes(destination)) {
                return true;
            }
        }
        return false;
    }

    function hasChildrenWithDestination(node, destination) {
        if (!node.children || node.children.length === 0) {
            return false;
        }
        
        for (const child of node.children) {
            if (child.type === 'folder') {
                const childPolicy = folderPolicies[child.id];
                if (childPolicy && childPolicy.destinations.includes(destination)) {
                    return true;
                }
                // Recursively check grandchildren
                if (hasChildrenWithDestination(child, destination)) {
                    return true;
                }
            }
        }
        return false;
    }

    function getBackupStatusIcon(nodeId, destination, isFolder, node) {
        if (!isFolder) {
            const backupStatus = backupStatusMap[nodeId];
            if (backupStatus && backupStatus[destination]) {
                const status = backupStatus[destination].status;
                const lastSync = backupStatus[destination].last_sync;
                if (status === 'synced') {
                    return `<i class="bi bi-check-circle-fill backup-status-icon synced" title="Backed up: ${lastSync || 'Unknown'}"></i>`;
                } else if (status === 'pending') {
                    return `<i class="bi bi-clock-fill backup-status-icon pending" title="Pending backup"></i>`;
                } else if (status === 'failed') {
                    return `<i class="bi bi-x-circle-fill backup-status-icon failed" title="Backup failed"></i>`;
                }
            }
            return `<i class="bi bi-circle backup-status-icon not-configured" title="Not yet backed up"></i>`;
        } else {
            const folderStats = folderStatsMap[node.name];
            if (folderStats && folderStats[destination]) {
                const stats = folderStats[destination];
                if (stats.synced === stats.total && stats.total > 0) {
                    return `<i class="bi bi-check-circle-fill backup-status-icon synced" title="Fully backed up (${stats.synced}/${stats.total})"></i>`;
                } else if (stats.synced > 0) {
                    return `<i class="bi bi-clock-fill backup-status-icon pending" title="Partially backed up (${stats.synced}/${stats.total})"></i>`;
                } else if (stats.total > 0) {
                    return `<i class="bi bi-circle backup-status-icon not-configured" title="Not backed up"></i>`;
                }
            }
            return `<i class="bi bi-circle backup-status-icon not-configured" title="No data"></i>`;
        }
    }

    function renderNodes(nodes, level, parentPath = []) {
        if (!nodes || nodes.length === 0) return '';
        let html = '';
        
        for (const node of nodes) {
            const isFolder = node.type === 'folder';
            const hasChildren = isFolder && (node.hasChildren || (node.children && node.children.length > 0));
            const syncStatus = syncStatusMap[node.id];
            const indent = '  '.repeat(level);
            const hasAWS = isFolder && hasDestination(node.id, 'aws_s3', parentPath);
            const hasB2 = isFolder && hasDestination(node.id, 'backblaze_b2', parentPath);
            
            // Check if children have destinations (for indeterminate state)
            const childrenHaveAWS = isFolder && !hasAWS && hasChildrenWithDestination(node, 'aws_s3');
            const childrenHaveB2 = isFolder && !hasB2 && hasChildrenWithDestination(node, 'backblaze_b2');
            
            let badges = '';
            if (syncStatus && syncStatus.status === 'synced') {
                badges += '<span class="badge-synced"><i class="bi bi-check-circle"></i> Synced</span>';
            }
            
            html += `
                <div class="tree-node" data-node-id="${node.id}">
                    <div class="tree-node-main">
                        ${indent}
                        ${hasChildren ? `
                            <div class="tree-expand collapsed" data-node-id="${node.id}">
                                <i class="bi bi-chevron-down"></i>
                            </div>
                        ` : '<span class="tree-indent"></span>'}
                        <div class="file-icon ${getIconClass(node)}">
                            ${getIcon(node)}
                        </div>
                        <div class="file-name">
                            ${escapeHtml(node.name)}
                            ${badges}
                        </div>
                        ${isFolder ? '' : `<div class="file-meta">${node.sizeFormatted || ''}</div>`}
                    </div>
                    ${isFolder ? `
                        <div class="tree-node-destinations">
                            <div class="dest-checkbox-group ${hasAWS || childrenHaveAWS ? 'active' : ''}">
                                <input type="checkbox" id="aws-${node.id}" ${hasAWS ? 'checked' : ''}
                                       data-folder-id="${node.id}" data-folder-name="${escapeHtml(node.name)}" data-destination="aws_s3"
                                       ${childrenHaveAWS ? 'data-indeterminate="true"' : ''}>
                                <label for="aws-${node.id}">
                                    <i class="bi bi-amazon dest-icon-aws"></i> S3
                                </label>
                                ${hasAWS || childrenHaveAWS ? getBackupStatusIcon(node.id, 'aws_s3', true, node) : ''}
                            </div>
                            <div class="dest-checkbox-group ${hasB2 || childrenHaveB2 ? 'active' : ''}">
                                <input type="checkbox" id="b2-${node.id}" ${hasB2 ? 'checked' : ''}
                                       data-folder-id="${node.id}" data-folder-name="${escapeHtml(node.name)}" data-destination="backblaze_b2"
                                       ${childrenHaveB2 ? 'data-indeterminate="true"' : ''}>
                                <label for="b2-${node.id}">
                                    <i class="bi bi-cloud-fill dest-icon-b2"></i> B2
                                </label>
                                ${hasB2 || childrenHaveB2 ? getBackupStatusIcon(node.id, 'backblaze_b2', true, node) : ''}
                            </div>
                        </div>
                    ` : `
                        <div class="tree-node-destinations">
                            <div class="backup-status-group">
                                ${getBackupStatusIcon(node.id, 'aws_s3', false, node)}
                                ${getBackupStatusIcon(node.id, 'backblaze_b2', false, node)}
                            </div>
                        </div>
                    `}
                </div>
            `;
            
            if (hasChildren) {
                const newPath = [...parentPath, node.id];
                const childrenHtml = node.children ? renderNodes(node.children, level + 1, newPath) : '';
                html += `
                    <div class="tree-children collapsed" id="children-${node.id}" data-loaded="${node.childrenLoaded || false}">
                        ${childrenHtml}
                    </div>
                `;
            }
        }
        return html;
    }

    async function toggleNode(event, nodeId, childrenLoaded) {
        event.stopPropagation();
        const expand = document.querySelector(`.tree-expand[data-node-id="${nodeId}"]`);
        const children = document.getElementById(`children-${nodeId}`);
        
        console.log('toggleNode called:', {nodeId, expand, children, childrenLoaded});
        
        if (!expand || !children) {
            console.error('Missing elements:', {expand, children});
            return;
        }
        
        if (children.classList.contains('collapsed')) {
            console.log('Expanding folder:', nodeId);
            if (!childrenLoaded) {
                console.log('Loading children from API...');
                try {
                    const response = await fetch(`/api/drive/folder/${nodeId}`);
                    const data = await response.json();
                    console.log('API response:', data);
                    if (data.success) {
                        const node = findNodeById(driveTree, nodeId);
                        if (node) {
                            node.children = data.children;
                            node.childrenLoaded = true;
                            children.innerHTML = renderNodes(data.children, getNodeLevel(nodeId) + 1, getNodePath(nodeId));
                            children.dataset.loaded = 'true';
                            console.log('Children loaded and rendered');
                            
                            // Set indeterminate state on newly rendered checkboxes
                            children.querySelectorAll('input[data-indeterminate="true"]').forEach(checkbox => {
                                checkbox.indeterminate = true;
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading children:', error);
                }
            }
            expand.classList.remove('collapsed');
            children.classList.remove('collapsed');
            console.log('Folder expanded, classes updated');
        } else {
            console.log('Collapsing folder:', nodeId);
            expand.classList.add('collapsed');
            children.classList.add('collapsed');
        }
    }

    async function toggleDestination(folderId, folderName, destination, enabled) {
        try {
            // Get current destinations for this folder
            const currentPolicy = folderPolicies[folderId];
            let currentDestinations = currentPolicy ? [...currentPolicy.destinations] : [];
            
            // Update destinations array
            if (enabled) {
                if (!currentDestinations.includes(destination)) {
                    currentDestinations.push(destination);
                }
            } else {
                currentDestinations = currentDestinations.filter(d => d !== destination);
            }
            
            // If no destinations remain, delete the policy
            if (currentDestinations.length === 0) {
                const response = await fetch(`/api/folders/policies/${folderId}`, {method: 'DELETE'});
                const data = await response.json();
                if (data.success) {
                    delete folderPolicies[folderId];
                    console.log(`Removed policy for folder ${folderId}`);
                } else {
                    console.error('Failed to delete policy:', data.error);
                }
            } else {
                // Add or update the policy with all destinations
                const response = await fetch('/api/folders/policies', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        folder_id: folderId,
                        folder_name: folderName,
                        folder_path: folderName,
                        destinations: currentDestinations
                    })
                });
                const data = await response.json();
                if (data.success) {
                    if (!folderPolicies[folderId]) {
                        folderPolicies[folderId] = {destinations: []};
                    }
                    folderPolicies[folderId].destinations = currentDestinations;
                    console.log(`Updated policy for folder ${folderId}:`, currentDestinations);
                } else {
                    console.error('Failed to update policy:', data.error);
                }
            }
        } catch (error) {
            console.error('Error toggling destination:', error);
        }
    }

    function expandAll() {
        document.querySelectorAll('.tree-expand.collapsed').forEach(el => el.click());
    }

    function collapseAll() {
        document.querySelectorAll('.tree-expand:not(.collapsed)').forEach(el => el.click());
    }

    function getIconClass(node) {
        if (node.type === 'folder') return 'folder';
        const mimeType = node.mimeType || '';
        if (mimeType.includes('document')) return 'document';
        if (mimeType.includes('spreadsheet')) return 'spreadsheet';
        if (mimeType.includes('presentation')) return 'presentation';
        if (mimeType.includes('image')) return 'image';
        if (mimeType.includes('video')) return 'video';
        if (mimeType.includes('pdf')) return 'pdf';
        return 'default';
    }

    function getIcon(node) {
        if (node.type === 'folder') return '<i class="bi bi-folder-fill"></i>';
        const iconClass = getIconClass(node);
        const icons = {
            document: 'bi-file-earmark-text',
            spreadsheet: 'bi-file-earmark-spreadsheet',
            presentation: 'bi-file-earmark-slides',
            image: 'bi-file-earmark-image',
            video: 'bi-file-earmark-play',
            pdf: 'bi-file-earmark-pdf',
            default: 'bi-file-earmark'
        };
        return `<i class="bi ${icons[iconClass] || icons.default}"></i>`;
    }

    function findNodeById(nodes, id) {
        for (const node of nodes) {
            if (node.id === id) return node;
            if (node.children) {
                const found = findNodeById(node.children, id);
                if (found) return found;
            }
        }
        return null;
    }

    function getNodeLevel(nodeId) {
        let level = 0;
        const node = document.querySelector(`[data-node-id="${nodeId}"]`);
        if (node) {
            let parent = node.parentElement;
            while (parent && !parent.classList.contains('tree-container')) {
                if (parent.classList.contains('tree-children')) level++;
                parent = parent.parentElement;
            }
        }
        return level;
    }

    function getNodePath(nodeId) {
        const path = [];
        let node = document.querySelector(`[data-node-id="${nodeId}"]`);
        while (node) {
            const parent = node.parentElement.closest('.tree-children');
            if (parent) {
                const parentId = parent.id.replace('children-', '');
                path.unshift(parentId);
                node = document.querySelector(`[data-node-id="${parentId}"]`);
            } else {
                break;
            }
        }
        return path;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Add event delegation for tree expand buttons
    document.addEventListener('click', function(e) {
        const expandBtn = e.target.closest('.tree-expand');
        if (expandBtn) {
            e.stopPropagation();
            const nodeId = expandBtn.dataset.nodeId;
            const children = document.getElementById(`children-${nodeId}`);
            const childrenLoaded = children.dataset.loaded === 'true';
            toggleNode(e, nodeId, childrenLoaded);
        }
    });

    // Add event delegation for destination checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.matches('.dest-checkbox-group input[type="checkbox"]')) {
            const folderId = e.target.dataset.folderId;
            const folderName = e.target.dataset.folderName;
            const destination = e.target.dataset.destination;
            const enabled = e.target.checked;
            toggleDestination(folderId, folderName, destination, enabled);
        }
    });

    // Prevent checkbox clicks from triggering row clicks
    document.addEventListener('click', function(e) {
        if (e.target.closest('.dest-checkbox-group')) {
            e.stopPropagation();
        }
    });
</script>
{% endblock %}
