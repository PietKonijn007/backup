{% extends "base.html" %}

{% block title %}Dashboard - Backup System{% endblock %}

{% block extra_css %}
<style>
    .service-status-card {
        background: linear-gradient(135deg, #232F3E 0%, #37475A 100%);
        color: white;
        border: none;
    }
    
    .control-buttons {
        display: flex;
        gap: var(--space-3);
        flex-wrap: wrap;
    }
    
    .destination-status {
        display: flex;
        gap: var(--space-4);
        padding: var(--space-4);
        background: var(--gray-50);
        border-radius: var(--radius-md);
        margin-top: var(--space-3);
    }
    
    .destination-item {
        flex: 1;
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3);
        background: white;
        border-radius: var(--radius-sm);
        border: 1px solid var(--gray-300);
    }
    
    .destination-icon {
        font-size: 2rem;
    }
    
    .activity-item {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        padding: var(--space-3);
        border-bottom: 1px solid var(--gray-200);
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-time {
        font-size: var(--text-xs);
        color: var(--gray-500);
        min-width: 60px;
    }
    
    .activity-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        flex-shrink: 0;
    }
    
    .activity-icon-success {
        background-color: #E8F5E9;
        color: var(--success);
    }
    
    .activity-icon-warning {
        background-color: #FFF3E0;
        color: var(--warning);
    }
</style>
{% endblock %}

{% block content %}
<!-- Service Status Overview -->
<div class="card-professional service-status-card">
    <div class="card-professional-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h3 style="color: white; margin-bottom: var(--space-3);">
                    <span class="status-dot" id="statusDot"></span>
                    Sync Daemon Status
                </h3>
                <div class="status-indicator" id="statusIndicator" style="background-color: rgba(255,255,255,0.2); color: white;">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span>Loading...</span>
                </div>
                <p class="mt-3 mb-0" style="color: rgba(255,255,255,0.8); font-size: var(--text-sm);" id="lastSyncTime">
                    Last sync: Checking...
                </p>
            </div>
            <div class="col-md-6 text-end">
                <div class="control-buttons" id="daemonControls" style="justify-content: flex-end;">
                    <button class="btn-professional-success" id="btnStart" onclick="startDaemon()">
                        <i class="bi bi-play-fill"></i> Start
                    </button>
                    <button class="btn-professional-warning" id="btnPause" onclick="pauseDaemon()" disabled>
                        <i class="bi bi-pause-fill"></i> Pause
                    </button>
                    <button class="btn-professional-success" id="btnResume" onclick="resumeDaemon()" disabled style="display:none;">
                        <i class="bi bi-play-circle"></i> Resume
                    </button>
                    <button class="btn-professional-danger" id="btnStop" onclick="stopDaemon()" disabled>
                        <i class="bi bi-stop-fill"></i> Stop
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Backup Destinations Status -->
<div class="card-professional">
    <div class="card-professional-header">
        <h5><i class="bi bi-cloud-upload"></i> Backup Destinations</h5>
    </div>
    <div class="card-professional-body">
        <div id="destinationsStatus">
            <div class="destination-status">
                <div class="destination-item">
                    <i class="bi bi-amazon destination-icon" style="color: #FF9900;"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: var(--space-1);">AWS S3</div>
                        <div style="font-size: var(--text-sm); color: var(--gray-600);">Checking...</div>
                    </div>
                </div>
                <div class="destination-item">
                    <i class="bi bi-cloud-fill destination-icon" style="color: #0091DA;"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: var(--space-1);">Backblaze B2</div>
                        <div style="font-size: var(--text-sm); color: var(--gray-600);">Checking...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="card-professional">
    <div class="card-professional-header">
        <h5><i class="bi bi-bar-chart"></i> Key Metrics</h5>
    </div>
    <div class="card-professional-body">
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">
                    <i class="bi bi-amazon" style="color: #FF9900;"></i> AWS Synced
                </div>
                <div class="metric-value metric-value-success" id="awsSynced">0</div>
                <div class="metric-sublabel" id="awsSize">0 B</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-label">
                    <i class="bi bi-cloud-fill" style="color: #0091DA;"></i> B2 Synced
                </div>
                <div class="metric-value metric-value-success" id="b2Synced">0</div>
                <div class="metric-sublabel" id="b2Size">0 B</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-label">
                    <i class="bi bi-clock"></i> AWS Pending
                </div>
                <div class="metric-value metric-value-warning" id="awsPending">0</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-label">
                    <i class="bi bi-clock"></i> B2 Pending
                </div>
                <div class="metric-value metric-value-warning" id="b2Pending">0</div>
            </div>
            
            <div class="metric-card" onclick="showFailedFiles()" style="cursor: pointer;">
                <div class="metric-label">
                    <i class="bi bi-exclamation-triangle"></i> Failed
                </div>
                <div class="metric-value metric-value-error" id="filesFailed">0</div>
                <div class="metric-sublabel">Click to view</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-label">
                    <i class="bi bi-hourglass-split"></i> Uptime
                </div>
                <div class="metric-value" id="uptime" style="font-size: var(--text-xl);">0s</div>
            </div>
        </div>
    </div>
</div>

<!-- Storage Overview -->
<div class="row">
    <div class="col-md-4">
        <div class="card-professional">
            <div class="card-professional-body" style="text-align: center;">
                <div class="metric-label">
                    <i class="bi bi-amazon" style="color: #FF9900;"></i> AWS S3 Storage
                </div>
                <div class="metric-value" id="awsTotalSize">0 B</div>
                <div class="metric-sublabel" id="awsFileCount">0 files</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-professional">
            <div class="card-professional-body" style="text-align: center;">
                <div class="metric-label">
                    <i class="bi bi-cloud-fill" style="color: #0091DA;"></i> B2 Storage
                </div>
                <div class="metric-value" id="b2TotalSize">0 B</div>
                <div class="metric-sublabel" id="b2FileCount">0 files</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-professional">
            <div class="card-professional-body" style="text-align: center;">
                <div class="metric-label">
                    <i class="bi bi-hdd"></i> Total Storage
                </div>
                <div class="metric-value" id="totalSize">0 B</div>
                <div class="metric-sublabel" id="totalFileCount">0 files</div>
            </div>
        </div>
    </div>
</div>

<!-- Error Alert -->
<div id="errorContainer" style="display:none;">
    <div class="alert-professional alert-professional-error">
        <i class="bi bi-exclamation-triangle"></i>
        <div>
            <strong>Last Error</strong>
            <p id="errorMessage" style="margin: var(--space-2) 0 0 0;"></p>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card-professional">
    <div class="card-professional-header">
        <h5><i class="bi bi-lightning-fill"></i> Quick Actions</h5>
    </div>
    <div class="card-professional-body">
        <div class="btn-group-professional">
            <a href="/files" class="btn-professional-primary">
                <i class="bi bi-folder"></i> Configure Backup Folders
            </a>
            <a href="/settings" class="btn-professional-secondary">
                <i class="bi bi-gear"></i> System Settings
            </a>
            <a href="/logs" class="btn-professional-secondary">
                <i class="bi bi-journal-text"></i> View System Logs
            </a>
        </div>
    </div>
</div>

<!-- Failed Files Modal -->
<div class="modal fade" id="failedFilesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-danger"></i> Failed Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="failedFilesContent">
                    <div class="text-center py-3">
                        <div class="spinner-professional"></div>
                        <p class="mt-3">Loading failed files...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn-professional-primary" onclick="retryFailedFiles()">
                    <i class="bi bi-arrow-clockwise"></i> Retry All
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let statusInterval;

    function updateStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.daemon) {
                    const daemon = data.daemon;
                    const stats = daemon.stats;
                    
                    // Update status indicator
                    const statusIndicator = document.getElementById('statusIndicator');
                    const statusDot = document.getElementById('statusDot');
                    
                    if (daemon.running && !daemon.paused) {
                        statusIndicator.innerHTML = '<span class="status-dot status-dot-running"></span><span>Running</span>';
                        statusIndicator.className = 'status-indicator status-indicator-running';
                        statusDot.className = 'status-dot status-dot-running';
                        updateButtons('running');
                    } else if (daemon.running && daemon.paused) {
                        statusIndicator.innerHTML = '<span class="status-dot status-dot-paused"></span><span>Paused</span>';
                        statusIndicator.className = 'status-indicator status-indicator-paused';
                        statusDot.className = 'status-dot status-dot-paused';
                        updateButtons('paused');
                    } else {
                        statusIndicator.innerHTML = '<span class="status-dot status-dot-stopped"></span><span>Stopped</span>';
                        statusIndicator.className = 'status-indicator status-indicator-stopped';
                        statusDot.className = 'status-dot status-dot-stopped';
                        updateButtons('stopped');
                    }
                    
                    // Update statistics
                    updateDetailedStatistics(data.daemon.detailed_stats || {});
                    
                    // Update last sync time
                    const lastSyncTime = document.getElementById('lastSyncTime');
                    if (daemon.last_sync_time) {
                        const syncDate = new Date(daemon.last_sync_time);
                        lastSyncTime.textContent = `Last sync: ${syncDate.toLocaleString()}`;
                    } else {
                        lastSyncTime.textContent = 'Last sync: Never';
                    }
                    
                    // Update uptime
                    document.getElementById('uptime').textContent = formatUptime(stats.uptime_seconds);
                    
                    // Show/hide error
                    if (stats.last_error) {
                        document.getElementById('errorContainer').style.display = 'block';
                        document.getElementById('errorMessage').textContent = stats.last_error;
                    } else {
                        document.getElementById('errorContainer').style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching status:', error);
            });
    }

    function updateButtons(state) {
        const btnStart = document.getElementById('btnStart');
        const btnPause = document.getElementById('btnPause');
        const btnResume = document.getElementById('btnResume');
        const btnStop = document.getElementById('btnStop');
        
        if (state === 'running') {
            btnStart.disabled = true;
            btnPause.disabled = false;
            btnPause.style.display = 'inline-flex';
            btnResume.style.display = 'none';
            btnStop.disabled = false;
        } else if (state === 'paused') {
            btnStart.disabled = true;
            btnPause.style.display = 'none';
            btnResume.disabled = false;
            btnResume.style.display = 'inline-flex';
            btnStop.disabled = false;
        } else {
            btnStart.disabled = false;
            btnPause.disabled = true;
            btnPause.style.display = 'inline-flex';
            btnResume.style.display = 'none';
            btnStop.disabled = true;
        }
    }

    function formatUptime(seconds) {
        if (seconds < 60) return `${seconds}s`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
        return `${Math.floor(seconds / 86400)}d`;
    }

    function updateDetailedStatistics(detailedStats) {
        document.getElementById('awsSynced').textContent = detailedStats.aws_synced || 0;
        document.getElementById('awsPending').textContent = detailedStats.aws_pending || 0;
        document.getElementById('awsSize').textContent = detailedStats.aws_size_formatted || '0 B';
        document.getElementById('awsTotalSize').textContent = detailedStats.aws_size_formatted || '0 B';
        document.getElementById('awsFileCount').textContent = `${detailedStats.aws_file_count || 0} files`;
        
        document.getElementById('b2Synced').textContent = detailedStats.b2_synced || 0;
        document.getElementById('b2Pending').textContent = detailedStats.b2_pending || 0;
        document.getElementById('b2Size').textContent = detailedStats.b2_size_formatted || '0 B';
        document.getElementById('b2TotalSize').textContent = detailedStats.b2_size_formatted || '0 B';
        document.getElementById('b2FileCount').textContent = `${detailedStats.b2_file_count || 0} files`;
        
        document.getElementById('filesFailed').textContent = detailedStats.total_failed || 0;
        document.getElementById('totalSize').textContent = detailedStats.total_size_formatted || '0 B';
        document.getElementById('totalFileCount').textContent = `${detailedStats.total_file_count || 0} files`;
    }

    function showFailedFiles() {
        const modal = new bootstrap.Modal(document.getElementById('failedFilesModal'));
        modal.show();
        
        fetch('/api/sync/failed-files')
            .then(response => response.json())
            .then(data => {
                const content = document.getElementById('failedFilesContent');
                
                if (data.success && data.failed_files.length > 0) {
                    let html = '<div class="table-responsive"><table class="table-professional">';
                    html += '<thead><tr><th>File Name</th><th>Destination</th><th>Error</th><th>Last Attempt</th><th>Actions</th></tr></thead><tbody>';
                    
                    data.failed_files.forEach(file => {
                        html += `
                            <tr>
                                <td><i class="bi bi-file-earmark"></i> ${escapeHtml(file.name)}</td>
                                <td>
                                    <span class="badge ${file.destination === 'aws_s3' ? 'bg-warning' : 'bg-info'}">
                                        ${file.destination === 'aws_s3' ? 'AWS S3' : 'Backblaze B2'}
                                    </span>
                                </td>
                                <td><small class="text-danger">${escapeHtml(file.error_message || 'Unknown error')}</small></td>
                                <td><small>${file.last_attempt ? new Date(file.last_attempt).toLocaleString() : 'Never'}</small></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="retryFile('${file.file_id}', '${file.destination}')">
                                        <i class="bi bi-arrow-clockwise"></i> Retry
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    content.innerHTML = html;
                } else if (data.success && data.failed_files.length === 0) {
                    content.innerHTML = '<div class="alert-professional alert-professional-success"><i class="bi bi-check-circle"></i><div>No failed files! All syncs are working correctly.</div></div>';
                } else {
                    content.innerHTML = '<div class="alert-professional alert-professional-error"><i class="bi bi-x-circle"></i><div>Error loading failed files: ' + (data.error || 'Unknown error') + '</div></div>';
                }
            })
            .catch(error => {
                document.getElementById('failedFilesContent').innerHTML = '<div class="alert-professional alert-professional-error"><i class="bi bi-x-circle"></i><div>Error loading failed files: ' + error.message + '</div></div>';
            });
    }

    function retryFile(fileId, destination) {
        fetch('/api/sync/retry-file', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({file_id: fileId, destination: destination})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('File retry initiated successfully!');
                showFailedFiles();
                updateStatus();
            } else {
                alert('Error retrying file: ' + data.error);
            }
        })
        .catch(error => alert('Error retrying file: ' + error.message));
    }

    function retryFailedFiles() {
        if (confirm('Retry all failed files? This may take some time.')) {
            fetch('/api/sync/retry-all-failed', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Retry initiated for ${data.retry_count} failed files!`);
                        bootstrap.Modal.getInstance(document.getElementById('failedFilesModal')).hide();
                        updateStatus();
                    } else {
                        alert('Error retrying files: ' + data.error);
                    }
                })
                .catch(error => alert('Error retrying files: ' + error.message));
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function startDaemon() {
        if (confirm('Start the sync daemon?')) {
            fetch('/api/sync/start', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Sync daemon started successfully!');
                        updateStatus();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => alert('Error starting daemon: ' + error));
        }
    }

    function stopDaemon() {
        if (confirm('Stop the sync daemon?')) {
            fetch('/api/sync/stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Sync daemon stopped successfully!');
                        updateStatus();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => alert('Error stopping daemon: ' + error));
        }
    }

    function pauseDaemon() {
        fetch('/api/sync/pause', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Sync daemon paused successfully!');
                    updateStatus();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => alert('Error pausing daemon: ' + error));
    }

    function resumeDaemon() {
        fetch('/api/sync/resume', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Sync daemon resumed successfully!');
                    updateStatus();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => alert('Error resuming daemon: ' + error));
    }

    // Initial load and start interval
    updateStatus();
    statusInterval = setInterval(updateStatus, 5000);
</script>
{% endblock %}
